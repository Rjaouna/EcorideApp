{% extends 'base.html.twig' %}

{% block title %}ContactMessage index{% endblock %}

{# --- CSS DataTables --- #}
{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
  <style>
    /* Ellipse le message long sur 2 lignes */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    table.dataTable td, table.dataTable th { vertical-align: middle; }
  </style>
{% endblock %}

{% block body %}
<section id="heroDriver" class="py-5 bg-light">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2 class="h3 text-primary mb-3">Demandes de contact</h2>
            <p class="lead mb-0">
              Retrouvez ici tous les messages envoyés par vos clients via le formulaire de contact. Vous pouvez les consulter, les marquer comme lus ou les archiver afin d’assurer un meilleur suivi de vos échanges.
            </p>
          </div>
        </div>
        <hr class="hr-blurry">
      </div>
    </div>
  </div>
</section>

<div class="container-fluid">
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table id="messagesTable" class="table table-striped table-hover align-middle nowrap" style="width:100%">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Email</th>
              <th>Message</th>
              <th>Date de réception</th>
              <th>Date d'ouverture</th>
              <th>Status</th>
              <th>Note</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          {% for contact_message in contact_messages %}
            {% set statusClasses = {
              'new': 'primary',
              'read': 'success',
              'archived': 'secondary',
              'spam': 'danger'
            } %}
            {% set statusClass = statusClasses[contact_message.status|lower]|default('secondary') %}

            <tr>
              <td>
                <a class="text-decoration-none text-secondary" href="{{ path('app_contact_message_show', {'id': contact_message.id}) }}">
                  {{ contact_message.name }}
                </a>
              </td>

              <td>
                <a class="text-decoration-none text-secondary" href="mailto:{{ contact_message.email }}">
                  {{ contact_message.email }}
                </a>
              </td>

              <td>
                <a class="text-decoration-none text-secondary d-block line-clamp-2" href="{{ path('app_contact_message_show', {'id': contact_message.id}) }}">
                  {{ contact_message.message }}
                </a>
              </td>

              <td data-order="{{ contact_message.createdAt ? contact_message.createdAt|date('Y-m-d H:i:s') : '' }}">
                <a class="text-decoration-none text-secondary" href="{{ path('app_contact_message_show', {'id': contact_message.id}) }}">
                  {{ contact_message.createdAt ? contact_message.createdAt|date('d/m/Y H:i') : '—' }}
                </a>
              </td>

              <td data-order="{{ contact_message.readAt ? contact_message.readAt|date('Y-m-d H:i:s') : '' }}">
                <a class="text-decoration-none text-secondary" href="{{ path('app_contact_message_show', {'id': contact_message.id}) }}">
                  {{ contact_message.readAt ? contact_message.readAt|date('d/m/Y H:i') : '—' }}
                </a>
              </td>

              <td data-search="{{ contact_message.status }}">
                <span class="badge bg-{{ statusClass }} text-uppercase">{{ contact_message.status }}</span>
              </td>

              <td>
                {% if contact_message.note %}
                  <span class="text-muted d-block line-clamp-2">{{ contact_message.note }}</span>
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>

              <td class="text-nowrap">
                <button
                  type="button"
                  class="btn btn-primary btn-sm text-white"
                  data-bs-toggle="modal"
                  data-bs-target="#noteModal"
                  data-url="{{ path('app_contact_message_note_update', {'id': contact_message.id}) }}"
                  data-name="{{ contact_message.name }}"
                  data-token="{{ csrf_token('note' ~ contact_message.id) }}"
                >
                  {% if contact_message.note %}Modifier la note{% else %}Ajouter une note{% endif %}
                </button>

                <a class="btn btn-warning text-white btn-sm"
                   href="{{ path('app_contact_message_archive', {'id': contact_message.id}) }}">
                  Archiver
                </a>
              </td>
            </tr>
         
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{# Modal #}
<div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="noteForm" method="post" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="noteModalLabel">Ajouter une note</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="noteText" class="form-label">Note</label>
          <textarea id="noteText" name="note" class="form-control" rows="4" required></textarea>
        </div>
        <input type="hidden" name="_token" id="noteToken" value="">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{# --- JS DataTables  #}
{% block javascripts %}
  {{ parent() }}
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

  <script>
    // Init DataTable
    $(function () {
      const table = $('#messagesTable').DataTable({
        responsive: true,
        pageLength: 10,
        lengthMenu: [10, 25, 50, 100],
        order: [[3, 'desc']], 
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/fr-FR.json' },
        columnDefs: [
          { targets: [2, 6], searchable: true, orderable: false }, 
          { targets: [7], searchable: false, orderable: false },    
        ]
      });
    });

    // Modal "Note"
    document.addEventListener('DOMContentLoaded', function () {
      const noteModal = document.getElementById('noteModal');
      const noteForm  = document.getElementById('noteForm');
      const noteTitle = document.getElementById('noteModalLabel');
      const noteText  = document.getElementById('noteText');
      const noteToken = document.getElementById('noteToken');

      noteModal.addEventListener('show.bs.modal', function (event) {
        const button  = event.relatedTarget;
        const postUrl = button.getAttribute('data-url');
        const name    = button.getAttribute('data-name') || '';
        const token   = button.getAttribute('data-token') || '';

        noteForm.setAttribute('action', postUrl);
        noteToken.value = token;

        noteTitle.textContent = name ? `Ajouter une note pour ${name}` : 'Ajouter une note';
        noteText.value = '';
      });
    });
  </script>
{% endblock %}
