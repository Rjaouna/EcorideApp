{# templates/profile/index.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}Mon profil{% endblock %}

{% block body %}
{% set isPassenger = app.user and 'ROLE_PASSAGER' in app.user.roles %}
{% set isDriver    = app.user and 'ROLE_DRIVER'   in app.user.roles %}
{% set accesRide = isDriver ? '' : 'd-none' %}


<section class="py-5 bg-light">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <div>
		{% set mode = 'ROLE_DRIVER' in app.user.roles ? 'Conducteur' : 'Passager' %}
        <h1 class="h4 text-primary mb-1">Mon profil — vous êtes en mode {{ mode }}</h1>

		</h1>
        <p class="text-muted mb-0">Informations de votre compte et de vos véhicules.</p>
      </div>
    </div>
    <hr class="mt-4">
  </div>
</section>

<div class="container my-4">
  <div class="row g-4">

    {# ====== Colonne gauche : infos + voitures ====== #}
    <div class="col-lg-8">
      {# Carte profil #}
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
          {% set u = app.user %}
          {% set initial = (u.pseudo ?? u.nom ?? u.email)|slice(0,1)|upper %}

          <div class="d-flex align-items-center mb-4">
            <div class="rounded-circle d-inline-flex align-items-center justify-content-center me-3"
                 style="width:56px;height:56px;background:rgba(0,0,0,.06);">
              <span class="fw-bold">{{ initial }}</span>
            </div>
            <div>
              <div class="h5 mb-0">{{ u.prenom }} {{ u.nom }}</div>
              <div class="text-muted">
                {% set badges = [] %}
                {% if isDriver %}{% set badges = badges|merge(['<span class="badge bg-success me-1">Conducteur</span>']) %}{% endif %}
                {% if isPassenger %}{% set badges = badges|merge(['<span class="badge bg-primary me-1">Passager</span>']) %}{% endif %}
                {% if 'ROLE_ADMIN' in u.roles %}{% set badges = badges|merge(['<span class="badge bg-dark me-1">Admin</span>']) %}{% endif %}
                {{ badges|join(' ')|raw }}
                {% if u.isVerified %}<span class="badge bg-info text-dark">Email vérifié</span>{% endif %}
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="text-muted small">Pseudo</div>
              <div class="fw-semibold">{{ u.pseudo }}</div>
            </div>
            <div class="col-md-6">
              <div class="text-muted small">Sexe</div>
              <div class="fw-semibold">{{ u.sexe }}</div>
            </div>

            <div class="col-md-6">
              <div class="text-muted small">Email</div>
              <div><a href="mailto:{{ u.email }}">{{ u.email }}</a></div>
            </div>
            <div class="col-md-6">
              <div class="text-muted small">Téléphone</div>
              <div><a href="tel:{{ u.telephone }}">{{ u.telephone }}</a></div>
            </div>

            <div class="col-12">
              <div class="text-muted small">Adresse</div>
              <div class="fw-semibold">{{ u.adresse }}</div>
            </div>

            <div class="col-md-6">
              <div class="text-muted small">Date de naissance</div>
              <div>{{ u.naissanceAt ? u.naissanceAt|date('d/m/Y') : '—' }}</div>
            </div>
          </div>
        </div>
      </div>








    {% set isPassagerBloc = app.user and 'ROLE_PASSAGER' in app.user.roles ? '' : 'd-none' %}
    {% set isDriverBloc    = app.user and 'ROLE_DRIVER'   in app.user.roles ? '' : 'd-none' %}
      {# Carte réservée pour l'utilisateur en mode DRIVER #}
      <div class="card border-0 shadow-sm {{isDriverBloc}}">
  <div class="card-header bg-white d-flex justify-content-between align-items-center">
    <strong>Mes voitures</strong>
	{% if isPassenger %}
      <span class="badge rounded-pill bg-warning text-dark ms-2 d-inline-flex align-items-center">
        <i class="bi bi-exclamation-triangle me-1"></i>
        Mode passager : gestion du parc indisponible
      </span>
    {% endif %}
    <a href="{{ path('app_voiture_new') }}"
       class="btn btn-sm btn-outline-primary {{ isPassenger ? 'disabled' : '' }}"
       aria-disabled="{{ isPassenger ? 'true' : 'false' }}"
       {% if isPassenger %}tabindex="-1"{% endif %}>
      Ajouter
    </a>

  </div>


  <div class="card-body">
    {% if voitures is empty %}
      <div class="alert alert-info mb-0">Aucune voiture enregistrée.</div>
    {% else %}
      <div class="row g-3">
        {% for voiture in voitures %}
          {% set energieMap = {
            'electrique':'info','électrique':'info','hybride':'success',
            'essence':'primary','diesel':'secondary','gpl':'warning','gnv':'warning'
          } %}
          {% set energieClass = energieMap[voiture.energie|lower]|default('dark') %}

          <div class="col-12 col-md-6">
            <div class="card h-100 shadow-sm border-0 overflow-hidden">
              <img
                src="{{ asset('assets/img/conducteur-step-3.svg') }}"
                alt="Illustration voiture"
                class="card-img-top p-3"
                style="height:120px;object-fit:contain;"
              >
              <div class="card-body pt-0">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <h6 class="mb-0">{{ voiture.marque.nom }} {{ voiture.modele }}</h6>
                  <span class="badge bg-{{ energieClass }} text-uppercase">{{ voiture.energie }}</span>
                </div>
                <div class="text-muted small">{{ voiture.immatriculation }}</div>

                <div class="mt-2 d-flex gap-2">
                  <a href="{{ path('app_voiture_show', {'id': voiture.id}) }}"
                     class="btn btn-outline-secondary btn-sm {{ isPassenger ? 'disabled' : '' }}"
                     aria-disabled="{{ isPassenger ? 'true' : 'false' }}"
                     {% if isPassenger %}tabindex="-1"{% endif %}>
                    Voir
                  </a>
                  <a href="{{ path('app_voiture_edit', {'id': voiture.id}) }}"
                     class="btn btn-primary btn-sm text-white {{ isPassenger ? 'disabled' : '' }}"
                     aria-disabled="{{ isPassenger ? 'true' : 'false' }}"
                     {% if isPassenger %}tabindex="-1"{% endif %}>
                    Modifier
                  </a>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
</div>
{# Carte réservée pour l'utilisateur en mode Passager #}
     <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5 d-flex align-items-center gap-2" id="exampleModalLabel">
          <i class="bi bi-calendar2-event"></i> Mes trajets réservés
          {% if participations is defined %}<span class="badge bg-secondary">{{ participations|length }}</span>{% endif %}
        </h1>
      </div>

      <div class="modal-body">
        {% if participations is defined and participations is not empty %}
          <div class="list-group list-group-flush">
            {% for p in participations %}
              {% set conducteur = p.driver ?? p.user %}
              {% set placesRestantes = (p.nbPlace|default(0)) - (p.passagers|length|default(0)) %}
              {% set s = p.statut %}
              {% set badgeClass =
                s == 'PUBLISHED' ? 'bg-success' :
                (s == 'FULL' ? 'bg-warning text-dark' :
                (s == 'CANCELLED' ? 'bg-danger' :
                (s == 'PLANNED' ? 'bg-secondary' : 'bg-info'))) %}

              <a class="list-group-item list-group-item-action py-3" href="{{ path('app_couvoiturage_show', {'id': p.id}) }}">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1 fw-semibold text-truncate">
                    <i class="bi bi-geo-alt me-1"></i>
                    {{ p.lieuDepart }} <i class="bi bi-arrow-right mx-1"></i> {{ p.lieuArrivee }}
                  </h6>
                  <span class="badge {{ badgeClass }}">{{ s }}</span>
                </div>

                <div class="small text-muted d-flex flex-wrap gap-3 mt-1">
                  <span><i class="bi bi-calendar2 me-1"></i>{{ p.departAt ? p.departAt|date('d/m/Y H:i') : '—' }}</span>
                  <span><i class="bi bi-cash-coin me-1"></i>{{ p.prixPersonne }} €</span>
                  {% if conducteur %}<span><i class="bi bi-person me-1"></i>{{ conducteur.prenom }} {{ conducteur.nom }}</span>{% endif %}
                  {% if p.voiture is defined and p.voiture %}
                    <span><i class="bi bi-car-front me-1"></i>{{ p.voiture.marque.nom }} {{ p.voiture.modele }}</span>
                  {% endif %}
                  {% if p.nbPlace is defined %}
                    <span><i class="bi bi-people me-1"></i>
                      {% if placesRestantes > 0 %}
                        {{ placesRestantes }} place{{ placesRestantes>1 ? 's' : '' }} restante{{ placesRestantes>1 ? 's' : '' }}
                      {% else %}
                        Complet
                      {% endif %}
                    </span>
                  {% endif %}
                </div>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle me-1"></i> Vous n’avez réservé aucun trajet pour l’instant.
          </div>
        {% endif %}
      </div>

     
    </div>
  </div>

</div>






    {# ====== Colonne droite : Actions ====== #}
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white">
          <strong>Actions</strong>
        </div>
        <div class="card-body d-grid gap-2">
          <a href="#" class="btn btn-outline-secondary"><i class="bi bi-person me-1" aria-hidden="true"></i> Modifier mon profil</a>
          <a href="{{path('app_preference_utilisateur_index')}}" class="btn btn-outline-secondary {{ isPassenger ? 'd-none' : '' }}"><i class="bi bi-sliders2 me-1" aria-hidden="true"></i> Mes préférences</a>
<a class="btn btn-outline-secondary  {{accesRide}}" href="{{path('app_couvoiturage_index')}}">
         Mes couvoiturage
      </a>
          <a href="{{ path('app_voiture_new') }}"
             class="btn btn-outline-secondary {{ isPassenger ? 'd-none' : '' }}"
             aria-disabled="{{ isPassenger ? 'true' : 'false' }}"
             {% if isPassenger %}tabindex="-1"{% endif %}>
            <i class="bi bi-plus-lg me-1" aria-hidden="true"></i> Ajouter une voiture
          </a>

          <form method="post" action="{{ path('app_switch_mode') }}">
            <input type="hidden" name="_token" value="{{ csrf_token('switch_mode') }}">
            <button type="submit" class="btn btn-outline-secondary w-100">
              <i class="bi {{ isDriver ? 'bi-person' : 'bi-car-front' }} me-2"></i>
              {{ isDriver ? 'Passer en mode Passager' : 'Passer en mode Conducteur' }}
            </button>
          </form>

      

          <a href="{{ path('app_logout') }}" class="btn btn-outline-danger"><i class="bi bi-door-closed"></i> Se déconnecter</a>
        </div>
      </div>
    </div>

  </div>
</div>

<style>
  .swatch{width:14px;height:14px;border-radius:50%;border:1px solid rgba(0,0,0,.15);display:inline-block}
</style>
{% endblock %}
