{% extends 'base.html.twig' %}

{% block title %}Trouver un trajet{% endblock %}

{% block body %}
<section id="heroDriver" class="py-5 bg-light">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2 class="h3 text-primary mb-3">Vous cherchez un trajet ?</h2>
            <p class="lead mb-0">
              Trouvez un conducteur et voyagez à petit prix, facilement et en toute sécurité.
            </p>
          </div>
        </div> {# ✅ fermeture du d-flex #}
        <hr class="my-4">
      </div>
    </div>
  </div>
</section>

<div class="container my-3">
  <div id="trajets-error" class="alert alert-danger d-none"></div>

  <div id="trajets-spinner" class="text-center my-3 d-none">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Chargement…</span>
    </div>
  </div>

  <div id="trajets-list" class="row g-3"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios@1/dist/axios.min.js"></script>
<script>
  const API_URL = '{{ path('app_api_trouver_un_trajet') }}';

  // Récupère les paramètres de l’URL (et valeurs passées par le contrôleur Twig)
  const qs = new URLSearchParams(window.location.search);
  const depart   = qs.get('depart')   || '{{ depart|default('')|e('js') }}';
  const arrivee  = qs.get('arrivee')  || '{{ arrivee|default('')|e('js') }}';
  const departAt = qs.get('departAt') || '{{ departAt|default('')|e('js') }}';

  const listEl  = document.getElementById('trajets-list');
  const spinEl  = document.getElementById('trajets-spinner');
  const errorEl = document.getElementById('trajets-error');

  document.addEventListener('DOMContentLoaded', loadTrajets);

  async function loadTrajets() {
    show(spinEl); hide(errorEl);
    try {
      // ⚠️ Un seul objet config pour axios.get
      const params = {};
      if (depart)   params.depart = depart;
      if (arrivee)  params.arrivee = arrivee;
      if (departAt) params.departAt = departAt;

      const { data } = await axios.get(API_URL, {
        params,
        headers: { 'Accept': 'application/json' }
      });

      render(data.data || []);
    } catch (e) {
      errorEl.textContent = e?.response?.data?.message || 'Une erreur est survenue.';
      show(errorEl);
    } finally {
      hide(spinEl);
    }
  }

  function render(items) {
    if (!items.length) {
      listEl.innerHTML = '<div class="col-12 text-muted">Aucun trajet trouvé.</div>';
      return;
    }

    listEl.innerHTML = items.map(item => {
      // ✅ construire l’URL JS en dehors du HTML
      const showUrl = '{{ path('app_couvoiturage_show', {'id': '__RID__'}) }}'.replace('__RID__', item.id);

      return `
        <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
          <div class="card h-100 shadow-sm border-0 position-relative card-hover">
            <div class="card-body d-flex flex-column">
              <h6 class="fw-bold mb-1 text-truncate">
                <i class="bi bi-geo-alt me-1"></i>
                ${esc(item.lieuDepart)} <i class="bi bi-arrow-right mx-1"></i> ${esc(item.lieuArrivee)}
              </h6>
              <div class="small text-muted mb-2">
                <i class="bi bi-calendar2 me-1"></i>${fmtDate(item.departAt)}
              </div>
              <div class="fw-bold text-primary mb-2">
                <i class="bi bi-cash-coin me-1"></i>${num(item.prixPersonne)} €
              </div>
              <div class="mt-auto small text-muted">
                <i class="bi bi-person me-1"></i>
                ${item.driver ? esc(item.driver.prenom + ' ' + item.driver.nom) : '—'}
              </div>
              <a href="${showUrl}" class="stretched-link" aria-label="Voir le trajet"></a>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // Helpers
  function fmtDate(iso){
    if(!iso) return '—';
    try {
      const d = new Date(iso);
      return d.toLocaleString('fr-FR', {
        day:'2-digit', month:'2-digit', year:'numeric',
        hour:'2-digit', minute:'2-digit'
      });
    } catch { return '—'; }
  }
  function num(v){ return Number(v ?? 0).toFixed(2).replace('.', ','); }
  function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
  function show(el){ el.classList.remove('d-none'); }
  function hide(el){ el.classList.add('d-none'); }
</script>

<style>
  .card-hover{ transition: transform .2s ease, box-shadow .2s ease; }
  .card-hover:hover{ transform: translateY(-2px); box-shadow: 0 .5rem 1rem rgba(0,0,0,.08); }
</style>
{% endblock %}
