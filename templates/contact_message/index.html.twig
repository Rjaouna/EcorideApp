{% extends 'base.html.twig' %}

{% block title %}ContactMessage index{% endblock %}

{% block body %}
<section id="heroDriver" class="py-5 bg-light">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-12 col-md-10 col-lg-8">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2 class="h3 text-primary mb-3">Demandes de contact</h2>
            <p class="lead mb-0">
              Retrouvez ici tous les messages envoyés par vos clients via le formulaire de contact. Vous pouvez les consulter, les marquer comme lus ou les archiver afin d’assurer un meilleur suivi de vos échanges.
            </p>
          </div>
        </div>
        <hr class="hr-blurry">
      </div>
    </div>
  </div>
</section>

<table class="table">
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Message</th>
      <th>CreatedAt</th>
      <th>ReadAt</th>
      <th>Status</th>
      <th>Note</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
  {% for contact_message in contact_messages %}
    <tr>
      <td>
        <a class="text-decoration-none text-secondary" href="{{ path('app_contact_message_show', {'id': contact_message.id}) }}">
          {{ contact_message.name }}
        </a>
      </td>
      <td>
        <a class="text-decoration-none text-secondary" href="{{ path('app_contact_message_show', {'id': contact_message.id}) }}">
          {{ contact_message.email }}
        </a>
      </td>
      <td>
        <a class="text-decoration-none text-secondary" href="{{ path('app_contact_message_show', {'id': contact_message.id}) }}">
          {{ contact_message.message }}
        </a>
      </td>
      <td>
        <a class="text-decoration-none text-secondary" href="{{ path('app_contact_message_show', {'id': contact_message.id}) }}">
          {{ contact_message.createdAt ? contact_message.createdAt|date('Y-m-d H:i:s') : '' }}
        </a>
      </td>
      <td>
        <a class="text-decoration-none text-secondary" href="{{ path('app_contact_message_show', {'id': contact_message.id}) }}">
          {{ contact_message.readAt ? contact_message.readAt|date('Y-m-d H:i:s') : '' }}
        </a>
      </td>

      <td>{{ contact_message.status }}</td>
      <td>{{ contact_message.note }}</td>

      <td class="text-nowrap">
        {# Bouton qui ouvre le modal et passe l'URL + nom + token #}
        <button
          type="button"
          class="btn btn-primary btn-sm text-white"
          data-bs-toggle="modal"
          data-bs-target="#noteModal"
          data-url="{{ path('app_contact_message_note_update', {'id': contact_message.id}) }}"
          data-name="{{ contact_message.name }}"
          data-token="{{ csrf_token('note' ~ contact_message.id) }}"
        >
          {% if contact_message.note %}
            Modifier la note
            {% else %}
            Ajouter une note
          {% endif %}
        </button>

        
        <a class="btn btn-warning text-white btn-sm" href="{{ path('app_contact_message_archive', {'id': contact_message.id}) }}">
          Archiver
        </a>
      </td>
    </tr>
  {% else %}
    <tr>
      <td colspan="8">Aucun message</td>
    </tr>
  {% endfor %}
  </tbody>
</table>

{# Modal unique réutilisé #}
<div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="noteForm" method="post" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="noteModalLabel">Ajouter une note</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="noteText" class="form-label">Note</label>
          <textarea id="noteText" name="note" class="form-control" rows="4" required></textarea>
        </div>
        <input type="hidden" name="_token" id="noteToken" value="">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const noteModal = document.getElementById('noteModal');
    const noteForm  = document.getElementById('noteForm');
    const noteTitle = document.getElementById('noteModalLabel');
    const noteText  = document.getElementById('noteText');
    const noteToken = document.getElementById('noteToken');

    noteModal.addEventListener('show.bs.modal', function (event) {
      const button  = event.relatedTarget; // bouton qui a ouvert le modal
      const postUrl = button.getAttribute('data-url');
      const name    = button.getAttribute('data-name') || '';
      const token   = button.getAttribute('data-token') || '';

      // Fixe l'action & le token pour ce message
      noteForm.setAttribute('action', postUrl);
      noteToken.value = token;

      // Titre contextuel + reset du textarea
      noteTitle.textContent = name ? `Ajouter une note pour ${name}` : 'Ajouter une note';
      noteText.value = '';
    });
  });
</script>
{% endblock %}
